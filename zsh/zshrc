[ -f $HOME/dotfiles/zsh/work ] && source $HOME/dotfiles/zsh/work

typeset -U PATH
autoload -U colors && colors

git_branch_prompt() {
  if git rev-parse --is-inside-work-tree &>/dev/null 2>&1; then
    local branch dirty

    # Use git describe for faster branch detection
    branch=$(git symbolic-ref --quiet --short HEAD 2>/dev/null)
    if [[ -z "$branch" ]]; then
      branch=$(git rev-parse --short HEAD 2>/dev/null)
    fi

    # Quick dirty check - only check if git status is dirty
    [[ -n $(git status --porcelain 2>/dev/null) ]] && dirty="*"

    echo " (${branch}${dirty})"
  fi
}

setopt prompt_subst
NEWLINE=$'\n'
PS1="%F{green}[clown@"
if [[ -n "$SSH_CONNECTION" ]]; then
  PS1+="%{$SSH_CONNECTION%% *%%}"
else
  PS1+="local"
fi
PS1+="] %~\$(git_branch_prompt)%f$NEWLINE >> "

ZSH_DISABLE_COMPFIX=true

# Environment variables
export DOTFILES="$HOME/dotfiles"

# PATH configuration
export PATH=/usr/local/bin:$PATH
export PATH=/usr/local/sbin:$PATH
export PATH=~/.composer/vendor/bin:$PATH
export PATH="${pwd}/node_modules/.bin:$PATH"  # execute locally installed npm modules
export PATH="$HOME/.bin:$PATH"                # put things in ~/.bin into my $PATH

setopt AUTO_CD              # Go to folder path without using cd.

bindkey '^f' autosuggest-accept

# Optimize completion system with caching
autoload -Uz compinit
# Only regenerate once a day
if [[ -n ~/.zcompdump(#qN.mh+24) ]]; then
    compinit
else
    compinit -C
fi

zstyle ':completion:*' completer _extensions _complete _approximate
zstyle ':completion:*' menu select  # menu with selection
zstyle ':completion:*' increment yes
zstyle ':completion:*' verbose yes
zstyle ':completion:*' squeeze-slashes yes  # replace // with /
zstyle ':completion:*' file-sort modification  # show recently used files first
zstyle ':completion:*' list-dirs-first yes
zstyle ':completion:*' list-colors "${(s.:.)LS_COLORS}"  # colored files and directories, blue selection box
zstyle ':completion:*' ignored-patterns '.git'
zstyle ':completion:*' rehash false  # improves performance
zstyle ':completion:*' use-cache true

bindkey '^I' complete-word  # Tab, complete instead of expand-and-complete
bindkey '^[[3~' delete-char  # Delete
bindkey '^[[Z' reverse-menu-complete  # Shift+Tab
bindkey '^[[1;5D' backward-word  # Control-Left
bindkey '^[[1;5C' forward-word  # Control-Right

TZ="Europe/London"
HISTFILE=$HOME/.zhistory
HISTSIZE=20000
SAVEHIST=20000
setopt INC_APPEND_HISTORY     # Immediately append to history file.
setopt EXTENDED_HISTORY       # Record timestamp in history.
setopt HIST_EXPIRE_DUPS_FIRST # Expire duplicate entries first when trimming history.
setopt HIST_IGNORE_DUPS       # Dont record an entry that was just recorded again.
setopt HIST_IGNORE_ALL_DUPS   # Delete old recorded entry if new entry is a duplicate.
setopt HIST_FIND_NO_DUPS      # Do not display a line previously found.
setopt HIST_IGNORE_SPACE      # Dont record an entry starting with a space.
setopt HIST_SAVE_NO_DUPS      # Dont write duplicate entries in the history file.
setopt SHARE_HISTORY          # Share history between all sessions.
unsetopt HIST_VERIFY          # Execute commands using history (e.g.: using !$) immediately
HOSTNAME="`hostname`"
PAGER='less'
export AUTOENV_FILE_ENTER=".env"
DEFAULT_USER="t"
unsetopt correct
unsetopt correctall
DISABLE_CORRECTION="true"

GIT_MERGE_AUTOEDIT=no
export GIT_MERGE_AUTOEDIT

export EDITOR='nvim'
export VEDITOR='code'

source $HOME/dotfiles/zsh/functions
source $HOME/dotfiles/zsh/aliases

# Optimize autosuggestions
ZSH_AUTOSUGGEST_BUFFER_MAX_SIZE=20
ZSH_AUTOSUGGEST_USE_ASYNC=true

#FZF - defer loading
source <(fzf --zsh)

# Load syntax highlighting last (as recommended) and with optimizations
# Cache brew prefix to avoid multiple calls
BREW_PREFIX="${BREW_PREFIX:-$(brew --prefix)}"
ZSH_HIGHLIGHT_FILE="$BREW_PREFIX/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh"
autosuggest_path="$BREW_PREFIX/share/zsh-autosuggestions/zsh-autosuggestions.zsh"

[[ -f $autosuggest_path ]] && source "$autosuggest_path"
[[ -f $ZSH_HIGHLIGHT_FILE ]] && source $ZSH_HIGHLIGHT_FILE
